<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Course Page - PrepEngine</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/header.css">
    <script src="js/api.js"></script>
    <script src="js/header-init.js"></script>
    <style>
        .course-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            margin-bottom: 32px;
        }
        .course-img {
            width: 100%;
            max-width: 600px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
        .resource-section {
            margin: 36px 0;
            text-align: left;
        }
        .section-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
        }
        .section-title i {
            margin-right: 12px;
        }
        .resource-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .resource-item {
            padding: 1.2rem 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        .resource-item:hover {
            background-color: #f8f9ff;
        }
        .resource-item:last-child {
            border-bottom: none;
        }
        .resource-item-info {
            flex: 1;
            padding-right: 1rem;
        }
        .resource-item-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: #333;
            font-size: 1.05rem;
            text-align: left;
        }
        .resource-item-meta {
            font-size: 0.85rem;
            color: #777;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }        
        .resource-item-meta i {
            color: #666;
        }       
        .resource-item-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 140px;
            justify-content: flex-end;
        }        
        .resource-item-download {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #3f51b5;
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 500;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }        
        .resource-item-download:hover {
            background-color: rgba(63, 81, 181, 0.1);
        } 
        .star-btn {
            background: none;
            border: none;
            color: #ffc107;
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.2s;
            padding: 0.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        
        .star-btn:hover {
            background-color: rgba(255, 193, 7, 0.1);
            transform: scale(1.1);
        }       
        .tab-container {
            margin: 30px 0;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            position: relative;
        }
        .tab.active {
            color: var(--primary-color);
        }
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-color);
            border-radius: 3px 3px 0 0;
        }
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Header styles (hamburger menu, side panel) moved to header.css */
    </style>
</head>
<body>
    <div class="bg-shape1"></div>
    <div class="bg-shape2"></div>
    <div class="bg-shape3"></div>
    <!-- Include the header and side panel -->
    <div id="header-container"></div>
    
    <div class="main-content">
        <div class="container">
            <div class="breadcrumb">
                <a href="index.html">Home</a>
                <span class="separator">/</span>
                <a href="course-list.html">Courses</a>
                <span class="separator">/</span>
                <span class="current" id="course-name">Loading Course...</span>
            </div>
            
            <div class="course-header">
                <h1 class="page-title" id="course-title">Loading Course...</h1>
            </div>
            
            <div class="tab-container">
                <div class="tabs">
                    <button class="tab active" onclick="openTab(event, 'notes')">Course Notes</button>
                    <button class="tab" onclick="openTab(event, 'papers')">Question Papers</button>
                    <button class="tab" onclick="openTab(event, 'syllabus')">Syllabus</button>
                </div>
                
                <div id="notes" class="tab-content active">
                    <div class="section-title">
                        <i class="fas fa-book-open"></i> Course Notes
                    </div>
                    <p>Comprehensive notes covering all major topics required for your examinations.</p>
                    
                    <div class="resource-list" id="notes-list">
                        <!-- Notes will be loaded dynamically from database -->
                        <p>Loading notes...</p>
                    </div>
                    
                    <div class="empty-state" id="notes-empty" style="display: none;">
                        <i class="fas fa-sticky-note"></i>
                        <h3>No Notes Available</h3>
                        <p>There are no notes available for this course yet.</p>
                    </div>
                </div>
                
                <div id="papers" class="tab-content">
                    <div class="section-title">
                        <i class="fas fa-file-alt"></i> Previous Year Question Papers
                    </div>
                    <p>Question papers from previous years to help you understand the exam pattern and important topics.</p>
                    
                    <div class="resource-list" id="papers-list">
                        <!-- Papers will be loaded dynamically from database -->
                        <p>Loading question papers...</p>
                    </div>
                    
                    <div class="empty-state" id="papers-empty" style="display: none;">
                        <i class="fas fa-file-alt"></i>
                        <h3>No Question Papers Available</h3>
                        <p>There are no question papers available for this course yet.</p>
                    </div>
                </div>
                
                <div id="syllabus" class="tab-content">
                    <div class="section-title">
                        <i class="fas fa-list-alt"></i> Course Syllabus
                    </div>
                    <p>Official syllabus documents for this course.</p>
                    
                    <div class="resource-list" id="syllabus-list">
                        <!-- Syllabus will be loaded dynamically from database -->
                        <p>Loading syllabus...</p>
                    </div>
                    
                    <div class="empty-state" id="syllabus-empty" style="display: none;">
                        <i class="fas fa-list-alt"></i>
                        <h3>No Syllabus Available</h3>
                        <p>There is no syllabus available for this course yet.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <script>
        // Function to switch between tabs
        function openTab(event, tabName) {
            // Hide all tab content
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // Remove active class from all tab buttons
            const tabButtons = document.getElementsByClassName('tab');
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            
            // Show the selected tab content and mark button as active
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }
        
        // Function to get URL parameters
        function getUrlParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Function to load course data
        function loadCourseData() {
            const courseName = getUrlParam('course');
            
            if (!courseName) {
                alert('Course name not specified. Redirecting to course list.');
                window.location.href = 'course-list.html';
                return;
            }
            
            // Update page title and breadcrumb with course name
            document.getElementById('course-title').textContent = courseName;
            document.getElementById('course-name').textContent = courseName;
            document.title = `${courseName} - NoteNexus`;
            
            console.log(`Loading course data for: ${courseName} at ${new Date().toISOString()}`);
            
            // Set loading state for all content containers
            document.getElementById('notes-list').innerHTML = '<p>Loading course notes...</p>';
            document.getElementById('papers-list').innerHTML = '<p>Loading question papers...</p>';
            document.getElementById('syllabus-list').innerHTML = '<p>Loading syllabus...</p>';
            
            // Show the loading sections
            document.getElementById('notes-list').style.display = 'block';
            document.getElementById('papers-list').style.display = 'block';
            document.getElementById('syllabus-list').style.display = 'block';
            
            // Hide empty states
            document.getElementById('notes-empty').style.display = 'none';
            document.getElementById('papers-empty').style.display = 'none';
            document.getElementById('syllabus-empty').style.display = 'none';
            
            // Fetch course data from API with a cache-busting query parameter
            const cacheBuster = new Date().getTime();
            const apiUrl = `http://localhost:3000/api/course/${encodeURIComponent(courseName)}?_=${cacheBuster}`;
            
            console.log('Requesting API URL:', apiUrl);
            
            fetch(apiUrl)
                .then(response => {
                    console.log('API response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`Failed to load course data: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received course data:', data);
                    // Load notes
                    const notesList = document.getElementById('notes-list');
                    const notesEmpty = document.getElementById('notes-empty');
                    
                    if (data.notes && data.notes.length > 0) {
                        notesList.innerHTML = '';
                        data.notes.forEach(note => {
                            // Check if note is saved
                            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                            const isSaved = currentUser && currentUser.savedNotes && 
                                currentUser.savedNotes.some(savedNote => savedNote.id === `${courseName}-${note.name}`);
                            const starClass = isSaved ? 'fas fa-star' : 'far fa-star';
                            
                            // Get file type for icon
                            let fileIcon = 'fa-file';
                            const fileExtension = note.type.toLowerCase();
                            if (fileExtension === 'pdf') fileIcon = 'fa-file-pdf';
                            else if (['doc', 'docx'].includes(fileExtension)) fileIcon = 'fa-file-word';
                            else if (['ppt', 'pptx'].includes(fileExtension)) fileIcon = 'fa-file-powerpoint';
                            else if (['txt', 'md'].includes(fileExtension)) fileIcon = 'fa-file-alt';
                            
                            notesList.innerHTML += `
                                <div class="resource-item">
                                    <div class="resource-item-info">
                                        <div class="resource-item-title">${note.name}</div>
                                        <div class="resource-item-meta">
                                            <i class="fas ${fileIcon}"></i> ${note.type.toUpperCase()}
                                        </div>
                                    </div>
                                    <div class="resource-item-actions">
                                        <a href="${note.path}" class="resource-item-download" download>
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                        <button class="star-btn" onclick="toggleSaveNote('${courseName}', '${note.name}', '${note.path}', this)">
                                            <i class="${starClass}"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        notesList.style.display = 'block';
                        notesEmpty.style.display = 'none';
                    } else {
                        notesList.style.display = 'none';
                        notesEmpty.style.display = 'block';
                    }
                    
                    // Load question papers
                    const papersList = document.getElementById('papers-list');
                    const papersEmpty = document.getElementById('papers-empty');
                    
                    // Check for questionPapers property (server.js uses this name)
                    const questionPapers = data.questionPapers || data.papers || [];
                    
                    if (questionPapers.length > 0) {
                        papersList.innerHTML = '';
                        questionPapers.forEach(paper => {
                            // Check if paper is saved
                            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                            const isSaved = currentUser && currentUser.savedPapers && 
                                currentUser.savedPapers.some(savedPaper => savedPaper.id === `${courseName}-${paper.name}`);
                            const starClass = isSaved ? 'fas fa-star' : 'far fa-star';
                            
                            // Get file type for icon
                            let fileIcon = 'fa-file';
                            const fileExtension = paper.type.toLowerCase();
                            if (fileExtension === 'pdf') fileIcon = 'fa-file-pdf';
                            else if (['doc', 'docx'].includes(fileExtension)) fileIcon = 'fa-file-word';
                            
                            papersList.innerHTML += `
                                <div class="resource-item">
                                    <div class="resource-item-info">
                                        <div class="resource-item-title">${paper.name}</div>
                                        <div class="resource-item-meta">
                                            <i class="fas ${fileIcon}"></i> ${paper.type.toUpperCase()}
                                        </div>
                                    </div>
                                    <div class="resource-item-actions">
                                        <a href="${paper.path}" class="resource-item-download" download>
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                        <button class="star-btn" onclick="toggleSavePaper('${courseName}', '${paper.name}', '${paper.path}', this)">
                                            <i class="${starClass}"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        papersList.style.display = 'block';
                        papersEmpty.style.display = 'none';
                    } else {
                        papersList.style.display = 'none';
                        papersEmpty.style.display = 'block';
                    }
                    
                    // Load syllabus
                    const syllabusList = document.getElementById('syllabus-list');
                    const syllabusEmpty = document.getElementById('syllabus-empty');
                    
                    if (data.syllabus && data.syllabus.length > 0) {
                        syllabusList.innerHTML = '';
                        data.syllabus.forEach(syllabus => {
                            // Check if syllabus is saved
                            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                            const isSaved = currentUser && currentUser.savedSyllabus && 
                                currentUser.savedSyllabus.some(savedSyllabus => savedSyllabus.id === `${courseName}-${syllabus.name}`);
                            const starClass = isSaved ? 'fas fa-star' : 'far fa-star';
                            
                            // Get file type for icon
                            let fileIcon = 'fa-file';
                            const fileExtension = syllabus.type.toLowerCase();
                            if (fileExtension === 'pdf') fileIcon = 'fa-file-pdf';
                            else if (['doc', 'docx'].includes(fileExtension)) fileIcon = 'fa-file-word';
                            else if (['ppt', 'pptx'].includes(fileExtension)) fileIcon = 'fa-file-powerpoint';
                            
                            syllabusList.innerHTML += `
                                <div class="resource-item">
                                    <div class="resource-item-info">
                                        <div class="resource-item-title">${syllabus.name}</div>
                                        <div class="resource-item-meta">
                                            <i class="fas ${fileIcon}"></i> ${syllabus.type.toUpperCase()}
                                        </div>
                                    </div>
                                    <div class="resource-item-actions">
                                        <a href="${syllabus.path}" class="resource-item-download" download>
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                        <button class="star-btn" onclick="toggleSaveSyllabus('${courseName}', '${syllabus.name}', '${syllabus.path}', this)">
                                            <i class="${starClass}"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        syllabusList.style.display = 'block';
                        syllabusEmpty.style.display = 'none';
                    } else {
                        syllabusList.style.display = 'none';
                        syllabusEmpty.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error loading course data:', error);
                    // Clear loading messages and show error
                    const errorMessage = '<p class="error-message">Failed to load course data. Please try again later.</p>';
                    
                    // Set error messages
                    document.getElementById('notes-list').innerHTML = errorMessage;
                    document.getElementById('papers-list').innerHTML = errorMessage;
                    document.getElementById('syllabus-list').innerHTML = errorMessage;
                    
                    // Show empty states
                    document.getElementById('notes-empty').style.display = 'block';
                    document.getElementById('papers-empty').style.display = 'block';
                    document.getElementById('syllabus-empty').style.display = 'block';
                    
                    // Hide loading lists
                    document.getElementById('notes-list').style.display = 'none';
                    document.getElementById('papers-list').style.display = 'none';
                    document.getElementById('syllabus-list').style.display = 'none';
                });
        }
        
        // Function to toggle saving a note
        async function toggleSaveNote(courseName, noteName, notePath, button) {
            // Check if user is logged in
            const token = localStorage.getItem('token');
            let currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!token || !currentUser) {
                // Redirect to login if not logged in
                alert('Please login to save notes');
                window.location.href = 'login.html';
                return;
            }
            
            try {
                // Create note object
                const noteData = {
                    title: noteName,
                    courseName: courseName,
                    url: notePath
                };
                
                // Create a unique ID for this note
                const noteId = `${courseName}-${noteName}`;
                
                // Check if the note is already saved in localStorage
                const isLocalSaved = currentUser.savedNotes && 
                    currentUser.savedNotes.some(note => 
                        (note.id === noteId) || 
                        (note.title === noteName && note.courseName === courseName));
                
                // Update UI to match localStorage state first
                if (isLocalSaved && !button.querySelector('i').classList.contains('fas')) {
                    button.querySelector('i').classList.remove('far');
                    button.querySelector('i').classList.add('fas');
                }
                
                // Check if the button has the 'fas' class (already saved in UI)
                const isSaved = button.querySelector('i').classList.contains('fas');
                
                if (!isSaved) {
                    // First check if it's already saved on the server
                    console.log('Checking if note is already saved on server...');
                    const checkResponse = await fetch('/api/saved/notes', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (checkResponse.ok) {
                        const savedNotes = await checkResponse.json();
                        const alreadySaved = savedNotes.some(note => 
                            (note.title === noteName && note.courseName === courseName));
                        
                        if (alreadySaved) {
                            console.log('Note is already saved on server, updating UI only');
                            // Update UI
                            button.querySelector('i').classList.remove('far');
                            button.querySelector('i').classList.add('fas');
                            
                            // Update localStorage
                            if (!currentUser.savedNotes) {
                                currentUser.savedNotes = [];
                            }
                            
                            // Add the note to the user's saved notes if it's not already there
                            if (!currentUser.savedNotes.some(note => 
                                (note.id === noteId) || 
                                (note.title === noteName && note.courseName === courseName))) {
                                currentUser.savedNotes.push({
                                    id: noteId,
                                    title: noteName,
                                    courseName: courseName,
                                    url: notePath
                                });
                                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            }
                            
                            return;
                        }
                    }
                    
                    // Save the note using the API
                    console.log('Saving note:', noteData);
                    const response = await fetch('/api/saved/note', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(noteData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        
                        // If the note is already saved, update the UI to reflect that
                        if (errorData.message === 'Note already saved') {
                            console.log('Note is already saved, updating UI');
                            button.querySelector('i').classList.remove('far');
                            button.querySelector('i').classList.add('fas');
                            
                            // Update localStorage
                            if (!currentUser.savedNotes) {
                                currentUser.savedNotes = [];
                            }
                            
                            // Add the note to the user's saved notes if it's not already there
                            if (!currentUser.savedNotes.some(note => 
                                (note.id === noteId) || 
                                (note.title === noteName && note.courseName === courseName))) {
                                currentUser.savedNotes.push({
                                    id: noteId,
                                    title: noteName,
                                    courseName: courseName,
                                    url: notePath
                                });
                                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            }
                            
                            // Don't show an error message for this case
                            return;
                        }
                        
                        throw new Error(errorData.message || 'Failed to save note');
                    }
                    
                    // Update UI
                    button.querySelector('i').classList.remove('far');
                    button.querySelector('i').classList.add('fas');
                    
                    // Update localStorage
                    if (!currentUser.savedNotes) {
                        currentUser.savedNotes = [];
                    }
                    
                    // Add the note to the user's saved notes if it's not already there
                    if (!currentUser.savedNotes.some(note => 
                        (note.id === noteId) || 
                        (note.title === noteName && note.courseName === courseName))) {
                        currentUser.savedNotes.push({
                            id: noteId,
                            title: noteName,
                            courseName: courseName,
                            url: notePath
                        });
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }
                    
                    // Also save the course if it's the first item saved from this course
                    console.log(`Auto-saving course: ${courseName}`);
                    await fetch('/api/saved/course', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ courseName })
                    });
                    
                    // Update saved courses in localStorage
                    if (!currentUser.savedCourses) {
                        currentUser.savedCourses = [];
                    }
                    
                    if (!currentUser.savedCourses.includes(courseName)) {
                        currentUser.savedCourses.push(courseName);
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }
                    
                } else {
                    // First get all saved notes to find the correct ID
                    console.log('Getting saved notes to find the correct ID for deletion...');
                    const getSavedNotesResponse = await fetch('/api/saved/notes', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!getSavedNotesResponse.ok) {
                        throw new Error('Failed to get saved notes for deletion');
                    }
                    
                    const savedNotes = await getSavedNotesResponse.json();
                    console.log('All saved notes:', savedNotes);
                    
                    // Find the note with matching title and course name
                    const noteToDelete = savedNotes.find(note => 
                        note.title === noteName && note.courseName === courseName);
                    
                    if (!noteToDelete) {
                        console.error('Note not found for deletion in server data');
                        // Even if we can't find it on the server, update the UI and localStorage
                        button.querySelector('i').classList.remove('fas');
                        button.querySelector('i').classList.add('far');
                        
                        if (currentUser.savedNotes) {
                            currentUser.savedNotes = currentUser.savedNotes.filter(note => 
                                !(note.id === noteId || (note.title === noteName && note.courseName === courseName)));
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        }
                        return;
                    }
                    
                    // Use the correct ID from the server for deletion
                    const serverNoteId = noteToDelete._id;
                    console.log('Found note ID for deletion:', serverNoteId);
                    
                    // Remove the note using the API with the correct ID
                    console.log('Removing note with ID:', serverNoteId);
                    const response = await fetch(`/api/saved/note/${serverNoteId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to remove note');
                    }
                    
                    // Update UI
                    button.querySelector('i').classList.remove('fas');
                    button.querySelector('i').classList.add('far');
                    
                    // Update localStorage
                    if (currentUser.savedNotes) {
                        currentUser.savedNotes = currentUser.savedNotes.filter(note => 
                            !(note.id === noteId || (note.title === noteName && note.courseName === courseName)));
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }
                }
                
            } catch (error) {
                console.error('Error toggling save note:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // Function to toggle saving a syllabus
        async function toggleSaveSyllabus(courseName, syllabusName, syllabusPath, button) {
            // Check if user is logged in
            const token = localStorage.getItem('token');
            let currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!token || !currentUser) {
                // Redirect to login if not logged in
                alert('Please login to save syllabus');
                window.location.href = 'login.html';
                return;
            }
            
            try {
                // Create syllabus object
                const syllabusData = {
                    title: syllabusName,
                    courseName: courseName,
                    url: syllabusPath
                };
                
                // Create a unique ID for this syllabus
                const syllabusId = `${courseName}-${syllabusName}`;
                
                // Check if the syllabus is already saved in localStorage
                const isLocalSaved = currentUser.savedSyllabus && 
                    currentUser.savedSyllabus.some(syllabus => 
                        (syllabus.id === syllabusId) || 
                        (syllabus.title === syllabusName && syllabus.courseName === courseName));
                
                // Update UI to match localStorage state first
                if (isLocalSaved && !button.querySelector('i').classList.contains('fas')) {
                    button.querySelector('i').classList.remove('far');
                    button.querySelector('i').classList.add('fas');
                }
                
                // Check if the button has the 'fas' class (already saved in UI)
                const isSaved = button.querySelector('i').classList.contains('fas');
                
                if (!isSaved) {
                    // First check if it's already saved on the server
                    console.log('Checking if syllabus is already saved on server...');
                    const checkResponse = await fetch('/api/saved/syllabus', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (checkResponse.ok) {
                        const savedSyllabus = await checkResponse.json();
                        const alreadySaved = savedSyllabus.some(syllabus => 
                            (syllabus.title === syllabusName && syllabus.courseName === courseName));
                        
                        if (alreadySaved) {
                            console.log('Syllabus is already saved on server, updating UI only');
                            // Update UI
                            button.querySelector('i').classList.remove('far');
                            button.querySelector('i').classList.add('fas');
                            
                            // Update localStorage
                            if (!currentUser.savedSyllabus) {
                                currentUser.savedSyllabus = [];
                            }
                            
                            // Add the syllabus to the user's saved syllabus if it's not already there
                            if (!currentUser.savedSyllabus.some(syllabus => 
                                (syllabus.id === syllabusId) || 
                                (syllabus.title === syllabusName && syllabus.courseName === courseName))) {
                                currentUser.savedSyllabus.push({
                                    id: syllabusId,
                                    title: syllabusName,
                                    courseName: courseName,
                                    url: syllabusPath
                                });
                                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            }
                            
                            return;
                        }
                    }
                    
                    // Save the syllabus using the API
                    console.log('Saving syllabus:', syllabusData);
                    const response = await fetch('/api/saved/syllabus', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(syllabusData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        
                        // If the syllabus is already saved, update the UI to reflect that
                        if (errorData.message === 'Syllabus already saved') {
                            console.log('Syllabus is already saved, updating UI');
                            button.querySelector('i').classList.remove('far');
                            button.querySelector('i').classList.add('fas');
                            
                            // Update localStorage
                            if (!currentUser.savedSyllabus) {
                                currentUser.savedSyllabus = [];
                            }
                            
                            // Add the syllabus to the user's saved syllabus if it's not already there
                            if (!currentUser.savedSyllabus.some(syllabus => 
                                (syllabus.id === syllabusId) || 
                                (syllabus.title === syllabusName && syllabus.courseName === courseName))) {
                                currentUser.savedSyllabus.push({
                                    id: syllabusId,
                                    title: syllabusName,
                                    courseName: courseName,
                                    url: syllabusPath
                                });
                                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            }
                            
                            // Don't show an error message for this case
                            return;
                        }
                        
                        throw new Error(errorData.message || 'Failed to save syllabus');
                    }
                    
                    // Update UI
                    button.querySelector('i').classList.remove('far');
                    button.querySelector('i').classList.add('fas');
                    
                    // Update localStorage
                    if (!currentUser.savedSyllabus) {
                        currentUser.savedSyllabus = [];
                    }
                    
                    // Add the syllabus to the user's saved syllabus if it's not already there
                    if (!currentUser.savedSyllabus.some(syllabus => 
                        (syllabus.id === syllabusId) || 
                        (syllabus.title === syllabusName && syllabus.courseName === courseName))) {
                        currentUser.savedSyllabus.push({
                            id: syllabusId,
                            title: syllabusName,
                            courseName: courseName,
                            url: syllabusPath
                        });
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }
                    
                    // Also save the course if it's the first item saved from this course
                    console.log(`Auto-saving course: ${courseName}`);
                    await fetch('/api/saved/course', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ courseName })
                    });
                    
                    // Update saved courses in localStorage
                    if (!currentUser.savedCourses) {
                        currentUser.savedCourses = [];
                    }
                    
                    if (!currentUser.savedCourses.includes(courseName)) {
                        currentUser.savedCourses.push(courseName);
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }
                    
                } else {
                    // First get all saved syllabus to find the correct ID
                    console.log('Getting saved syllabus to find the correct ID for deletion...');
                    const getSavedSyllabusResponse = await fetch('/api/saved/syllabus', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!getSavedSyllabusResponse.ok) {
                        throw new Error('Failed to get saved syllabus for deletion');
                    }
                    
                    const savedSyllabus = await getSavedSyllabusResponse.json();
                    console.log('All saved syllabus:', savedSyllabus);
                    
                    // Find the syllabus with matching title and course name
                    const syllabusToDelete = savedSyllabus.find(syllabus => 
                        syllabus.title === syllabusName && syllabus.courseName === courseName);
                    
                    if (!syllabusToDelete) {
                        console.error('Syllabus not found for deletion in server data');
                        // Even if we can't find it on the server, update the UI and localStorage
                        button.querySelector('i').classList.remove('fas');
                        button.querySelector('i').classList.add('far');
                        
                        if (currentUser.savedSyllabus) {
                            currentUser.savedSyllabus = currentUser.savedSyllabus.filter(syllabus => 
                                !(syllabus.id === syllabusId || (syllabus.title === syllabusName && syllabus.courseName === courseName)));
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        }
                        return;
                    }
                    
                    // Use the correct ID from the server for deletion
                    const serverSyllabusId = syllabusToDelete._id;
                    console.log('Found syllabus ID for deletion:', serverSyllabusId);
                    
                    // Remove the syllabus using the API with the correct ID
                    console.log('Removing syllabus with ID:', serverSyllabusId);
                    const response = await fetch(`/api/saved/syllabus/${serverSyllabusId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to remove syllabus');
                    }
                    
                    // Update UI
                    button.querySelector('i').classList.remove('fas');
                    button.querySelector('i').classList.add('far');
                    
                    // Update localStorage
                    if (currentUser.savedSyllabus) {
                        currentUser.savedSyllabus = currentUser.savedSyllabus.filter(syllabus => 
                            !(syllabus.id === syllabusId || (syllabus.title === syllabusName && syllabus.courseName === courseName)));
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }
                }
                
            } catch (error) {
                console.error('Error toggling save syllabus:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // Function to toggle saving a question paper
        async function toggleSavePaper(courseName, paperName, paperPath, button) {
            // Check if user is logged in
            const token = localStorage.getItem('token');
            let currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!token || !currentUser) {
                // Redirect to login if not logged in
                alert('Please login to save question papers');
                window.location.href = 'login.html';
                return;
            }
            
            try {
                // Create paper object
                const paperData = {
                    title: paperName,
                    courseName: courseName,
                    url: paperPath
                };
                
                // Create a unique ID for this paper
                const paperId = `${courseName}-${paperName}`;
                
                // Check if the paper is already saved in localStorage
                const isLocalSaved = currentUser.savedPapers && 
                    currentUser.savedPapers.some(paper => 
                        (paper.id === paperId) || 
                        (paper.title === paperName && paper.courseName === courseName));
                
                // Update UI to match localStorage state first
                if (isLocalSaved && !button.querySelector('i').classList.contains('fas')) {
                    button.querySelector('i').classList.remove('far');
                    button.querySelector('i').classList.add('fas');
                }
                
                // Check if the button has the 'fas' class (already saved in UI)
                const isSaved = button.querySelector('i').classList.contains('fas');
                
                if (!isSaved) {
                    // First check if it's already saved on the server
                    console.log('Checking if paper is already saved on server...');
                    const checkResponse = await fetch('/api/saved/papers', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (checkResponse.ok) {
                        const savedPapers = await checkResponse.json();
                        const alreadySaved = savedPapers.some(paper => 
                            (paper.title === paperName && paper.courseName === courseName));
                        
                        if (alreadySaved) {
                            console.log('Paper is already saved on server, updating UI only');
                            // Update UI
                            button.querySelector('i').classList.remove('far');
                            button.querySelector('i').classList.add('fas');
                            
                            // Update localStorage
                            if (!currentUser.savedPapers) {
                                currentUser.savedPapers = [];
                            }
                            
                            // Add the paper to the user's saved papers if it's not already there
                            if (!currentUser.savedPapers.some(paper => 
                                (paper.id === paperId) || 
                                (paper.title === paperName && paper.courseName === courseName))) {
                                currentUser.savedPapers.push({
                                    id: paperId,
                                    title: paperName,
                                    courseName: courseName,
                                    url: paperPath
                                });
                                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            }
                            
                            return;
                        }
                    }
                    
                    // Save the paper using the API
                    console.log('Saving paper:', paperData);
                    const response = await fetch('/api/saved/paper', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(paperData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        
                        // If the paper is already saved, update the UI to reflect that
                        if (errorData.message === 'Paper already saved') {
                            console.log('Paper is already saved, updating UI');
                            button.querySelector('i').classList.remove('far');
                            button.querySelector('i').classList.add('fas');
                            
                            // Update localStorage
                            if (!currentUser.savedPapers) {
                                currentUser.savedPapers = [];
                            }
                            
                            // Add the paper to the user's saved papers if it's not already there
                            if (!currentUser.savedPapers.some(paper => 
                                (paper.id === paperId) || 
                                (paper.title === paperName && paper.courseName === courseName))) {
                                currentUser.savedPapers.push({
                                    id: paperId,
                                    title: paperName,
                                    courseName: courseName,
                                    url: paperPath
                                });
                                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            }
                            
                            // Don't show an error message for this case
                            return;
                        }
                        
                        throw new Error(errorData.message || 'Failed to save paper');
                    }
                    
                    // Update UI
                    button.querySelector('i').classList.remove('far');
                    button.querySelector('i').classList.add('fas');
                    
                    // Update localStorage
                    if (!currentUser.savedPapers) {
                        currentUser.savedPapers = [];
                    }
                    
                    // Add the paper to the user's saved papers if it's not already there
                    if (!currentUser.savedPapers.some(paper => 
                        (paper.id === paperId) || 
                        (paper.title === paperName && paper.courseName === courseName))) {
                        currentUser.savedPapers.push({
                            id: paperId,
                            title: paperName,
                            courseName: courseName,
                            url: paperPath
                        });
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }
                    
                    // Also save the course if it's the first item saved from this course
                    console.log(`Auto-saving course: ${courseName}`);
                    await fetch('/api/saved/course', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ courseName })
                    });
                    
                    // Update saved courses in localStorage
                    if (!currentUser.savedCourses) {
                        currentUser.savedCourses = [];
                    }
                    
                    if (!currentUser.savedCourses.includes(courseName)) {
                        currentUser.savedCourses.push(courseName);
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }
                    
                } else {
                    // First get all saved papers to find the correct ID
                    console.log('Getting saved papers to find the correct ID for deletion...');
                    const getSavedPapersResponse = await fetch('/api/saved/papers', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!getSavedPapersResponse.ok) {
                        throw new Error('Failed to get saved papers for deletion');
                    }
                    
                    const savedPapers = await getSavedPapersResponse.json();
                    console.log('All saved papers:', savedPapers);
                    
                    // Find the paper with matching title and course name
                    const paperToDelete = savedPapers.find(paper => 
                        paper.title === paperName && paper.courseName === courseName);
                    
                    if (!paperToDelete) {
                        console.error('Paper not found for deletion in server data');
                        // Even if we can't find it on the server, update the UI and localStorage
                        button.querySelector('i').classList.remove('fas');
                        button.querySelector('i').classList.add('far');
                        
                        if (currentUser.savedPapers) {
                            currentUser.savedPapers = currentUser.savedPapers.filter(paper => 
                                !(paper.id === paperId || (paper.title === paperName && paper.courseName === courseName)));
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        }
                        return;
                    }
                    
                    // Use the correct ID from the server for deletion
                    const serverPaperId = paperToDelete._id;
                    console.log('Found paper ID for deletion:', serverPaperId);
                    
                    // Remove the paper using the API with the correct ID
                    console.log('Removing paper with ID:', serverPaperId);
                    const response = await fetch(`/api/saved/paper/${serverPaperId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to remove paper');
                    }
                    
                    // Update UI
                    button.querySelector('i').classList.remove('fas');
                    button.querySelector('i').classList.add('far');
                    
                    // Update localStorage
                    if (currentUser.savedPapers) {
                        currentUser.savedPapers = currentUser.savedPapers.filter(paper => 
                            !(paper.id === paperId || (paper.title === paperName && paper.courseName === courseName)));
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }
                }
                
            } catch (error) {
                console.error('Error toggling save paper:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // Tab switching functionality
        function switchTab(tabId) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabId).classList.add('active');
            
            // Update active tab button
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-tab') === tabId) {
                    btn.classList.add('active');
                }
            });
        }
        
        // Call the loadHeader function from header-init.js instead of defining it here      
        // Load header immediately
        loadHeader();
        
        // Initialize page
        // Load course data immediately when the page loads
        function initializePage() {
            console.log('Initializing page...');
            
            // Initialize content sections
            const notesList = document.getElementById('notes-list');
            const papersList = document.getElementById('papers-list');
            const syllabusList = document.getElementById('syllabus-list');
            
            if (notesList) notesList.innerHTML = '<p>Loading course notes...</p>';
            if (papersList) papersList.innerHTML = '<p>Loading question papers...</p>';
            if (syllabusList) syllabusList.innerHTML = '<p>Loading syllabus...</p>';
            
            // Make sure first tab is active by default
            const firstTab = document.querySelector('.tab');
            const notesContent = document.getElementById('notes');
            
            if (firstTab) firstTab.classList.add('active');
            if (notesContent) notesContent.classList.add('active');
            
            // Load the course data
            loadCourseData();
        }
        
        // Immediately call this once the script loads
        setTimeout(initializePage, 100);
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check if header loaded properly, if not retry
            if (!document.querySelector('#hamburger-btn')) {
                console.log('Header not loaded properly, retrying...');
                loadHeader();
            }
            
            // Check if user is logged in and update UI
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (currentUser) {
                console.log('User is logged in:', currentUser.name);
                // Update UI for logged in state
                try {
                    // Hide auth links and show user menu
                    const authLinks = document.getElementById('auth-links');
                    const userMenu = document.getElementById('user-menu');
                    const userName = document.querySelector('#user-name span');
                    
                    if (authLinks) authLinks.style.display = 'none';
                    if (userMenu) userMenu.style.display = 'block';
                    if (userName) userName.textContent = currentUser.name;
                    
                    // Update side panel
                    const sidePanelAuthLinks = document.getElementById('side-panel-auth-links');
                    const sidePanelUserLinks = document.getElementById('side-panel-user-links');
                    
                    if (sidePanelAuthLinks) sidePanelAuthLinks.style.display = 'none';
                    if (sidePanelUserLinks) sidePanelUserLinks.style.display = 'block';
                    
                    // Handle logout
                    const logoutBtn = document.getElementById('logout-btn');
                    if (logoutBtn) {
                        logoutBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            localStorage.removeItem('currentUser');
                            window.location.reload();
                        });
                    }
                } catch (error) {
                    console.error('Error updating UI for logged in user:', error);
                }
            } else {
                console.log('User is not logged in');
            }
            
            // Make sure course data is loaded
            if (!document.querySelector('#notes-list').innerHTML.includes('resource-item')) {
                console.log('Content not loaded yet, reloading...');
                initializePage();
            }
        });
    </script>
    <!-- Import API service -->
    <script src="js/api.js"></script>
</body>
</html>
